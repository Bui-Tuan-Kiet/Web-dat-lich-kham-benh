<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý khoa</title>
  <link rel="stylesheet" href="../AdminLayout/assets/css/bootstrap.min.css">
  <link rel="stylesheet" href="../AdminLayout/assets/css/font-awesome.min.css">
  <link rel="stylesheet" href="../AdminLayout/assets/css/style.css">
</head>
<body>
<div class="main-wrapper">
  <div class="header">
    <div class="header-left">
      <a href="Admin.html" class="logo">
        <img src="../AdminLayout/assets/img/logo.png" width="35" height="35" alt=""> <span>Preclinic</span>
      </a>
    </div>
    <a id="toggle_btn" href="#"><i class="fa fa-bars"></i></a>
    <ul class="nav user-menu float-right">
      <li class="nav-item dropdown has-arrow">
        <a href="#" class="dropdown-toggle nav-link user-link" data-toggle="dropdown">
          <span class="user-img"><img src="../AdminLayout/assets/img/user.jpg" class="rounded-circle" width="24"><span class="status online"></span></span>
          <span>Quản trị viên</span>
        </a>
        <div class="dropdown-menu">
          <a class="dropdown-item" href="#">Hồ sơ</a>
          <a class="dropdown-item" href="Caidat.html">Cài đặt</a>
          <a class="dropdown-item" href="login.html">Đăng xuất</a>
        </div>
      </li>
    </ul>
  </div>
  
  <div class="sidebar" id="sidebar">
    <div class="sidebar-inner slimscroll">
      <div id="sidebar-menu" class="sidebar-menu">
        <ul>
          <li class="menu-title">Chính</li>
          <li><a href="Admin.html"><i class="fa fa-dashboard"></i> <span>Bảng điều khiển</span></a></li>
          <li><a href="Bacsi.html"><i class="fa fa-user-md"></i> <span>Bác sĩ</span></a></li>
          <li><a href="Benhnhan.html"><i class="fa fa-wheelchair"></i> <span>Bệnh nhân</span></a></li>
          <li><a href="Lichhen.html"><i class="fa fa-calendar"></i> <span>Lịch hẹn</span></a></li>
          <li><a href="Nhanvien.html"><i class="fa fa-user"></i> <span>Nhân viên</span></a></li>
          <li class="active"><a href="Khoa.html"><i class="fa fa-hospital-o"></i> <span>Khoa</span></a></li>
          <li><a href="Ngaynghi.html"><i class="fa fa-calendar-times-o"></i> <span>Ngày nghỉ</span></a></li>
          <li><a href="Chamcong.html"><i class="fa fa-check-square-o"></i> <span>Chấm công</span></a></li>
          <li><a href="Taisan.html"><i class="fa fa-cube"></i> <span>Tài sản</span></a></li>
          <li><a href="Trochuyen.html"><i class="fa fa-comments"></i> <span>Trò chuyện</span></a></li>
          <li><a href="Caidat.html"><i class="fa fa-cog"></i> <span>Cài đặt</span></a></li>
        </ul>
      </div>
    </div>
  </div>

  <div class="page-wrapper">
    <div class="content container-fluid">
      <div class="page-header">
        <div class="row">
          <div class="col">
            <h3 class="page-title">Quản lý khoa</h3>
          </div>
          <div class="col-auto text-right">
            <button class="btn btn-primary" onclick="openAddKhoaModal()">
              <i class="fa fa-plus"></i> Thêm khoa
            </button>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Danh sách khoa</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered datatable">
              <thead>
                <tr>
                  <th>Mã khoa</th>
                  <th>Tên khoa</th>
                  <th>Mô tả</th>
                  <th>Trạng thái</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody>
                <!-- Dữ liệu load động tại đây -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Modal Thêm/Sửa Khoa -->
<!-- Modal Thêm/Sửa Khoa -->
<div class="modal fade" id="addEditKhoaModal" tabindex="-1" aria-labelledby="addEditKhoaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <form id="khoaForm">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="addEditKhoaModalLabel">Thông tin Khoa</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Đóng">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="maKhoa">
            <div class="mb-3">
              <label>Tên khoa</label>
              <input type="text" class="form-control" id="tenKhoa" required>
            </div>
            <div class="mb-3">
              <label>Mô tả</label>
              <textarea class="form-control" id="moTa" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label>Trạng thái</label>
              <select class="form-select" id="trangThai" required>
                <option value="">-- Chọn trạng thái --</option>
                <option value="Đang hoạt động">Đang hoạt động</option>
                <option value="Ngừng hoạt động">Ngừng hoạt động</option>
              </select>
            </div>
          </div>
          <div class="modal-footer justify-content-between">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
            <button type="submit" class="btn btn-primary">Lưu</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  

<script src="../AdminLayout/assets/js/jquery-3.2.1.min.js"></script>
<script src="../AdminLayout/assets/js/popper.min.js"></script>
<script src="../AdminLayout/assets/js/bootstrap.min.js"></script>
<script src="../AdminLayout/assets/js/app.js"></script>
<script>
$(document).ready(function() {
  loadKhoa();
});

async function loadKhoa() {
  try {
    const response = await fetch('http://localhost:3000/api/khoa');
    const khoaList = await response.json();
    renderKhoa(khoaList);
  } catch (error) {
    console.error('❌ Lỗi tải danh sách khoa:', error);
  }
}

function renderKhoa(khoaList) {
  const tbody = document.querySelector(".datatable tbody");
  tbody.innerHTML = "";

  khoaList.forEach(khoa => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${khoa.MaKhoa}</td>
      <td>${khoa.Ten}</td>
      <td>${khoa.MoTa || ''}</td>
      <td>${khoa.TrangThai || ''}</td>
      <td>
        <button class="btn btn-sm btn-warning" onclick='editKhoa(${JSON.stringify(khoa)})'>Sửa</button>
        <button class="btn btn-sm btn-danger" onclick='deleteKhoa("${khoa.MaKhoa}")'>Xoá</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function openAddKhoaModal() {
  document.getElementById("khoaForm").reset();
  document.getElementById("maKhoa").value = "";
  $('#addEditKhoaModal').modal('show');
}

function editKhoa(khoa) {
  document.getElementById("maKhoa").value = khoa.MaKhoa;
  document.getElementById("tenKhoa").value = khoa.Ten;
  document.getElementById("moTa").value = khoa.MoTa || "";
  document.getElementById("trangThai").value = khoa.TrangThai || "";
  $('#addEditKhoaModal').modal('show');
}

async function deleteKhoa(id) {
  if (confirm("Bạn có chắc muốn xoá khoa này?")) {
    try {
      const response = await fetch(`http://localhost:3000/api/khoa/${id}`, { method: "DELETE" });
      const result = await response.json();
      if (response.ok) {
        alert(result.message);
        loadKhoa();
      } else {
        alert("❌ " + result.message);
      }
    } catch (error) {
      console.error('❌ Lỗi khi xoá khoa:', error);
    }
  }
}

document.getElementById("khoaForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  const id = document.getElementById("maKhoa").value;
  const khoa = {
    Ten: document.getElementById("tenKhoa").value,
    MoTa: document.getElementById("moTa").value,
    TrangThai: document.getElementById("trangThai").value
  };

  const method = id ? "PUT" : "POST";
  const url = id ? `http://localhost:3000/api/khoa/${id}` : `http://localhost:3000/api/khoa`;

  try {
    const response = await fetch(url, {
      method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(khoa)
    });

    if (response.ok) {
      $('#addEditKhoaModal').modal('hide');
      document.getElementById("khoaForm").reset();
      loadKhoa();
      alert(id ? "✅ Cập nhật khoa thành công!" : "✅ Thêm khoa thành công!");
    } else {
      const result = await response.json();
      alert("❌ " + result.message);
    }
  } catch (error) {
    console.error('❌ Lỗi khi lưu khoa:', error);
  }
});
</script>
</body>
</html>
